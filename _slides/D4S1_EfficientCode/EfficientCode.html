<!DOCTYPE html>
<html>
  <head>
    <title>Efficient code</title>
    <meta charset="utf-8">
    <meta name="author" content="The R Bootcamp Twitter: @therbootcamp" />
    <link href="libs/remark-css/example.css" rel="stylesheet" />
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Efficient code
### The R Bootcamp<br/>Twitter: <a href='https://twitter.com/therbootcamp'><span class="citation">@therbootcamp</span></a>
### September 2017

---






# What is efficient code?

.pull-left4[
&gt;&lt;font size = 5&gt;"Programmers waste enormous amounts of time thinking about, or worrying about, the speed of noncritical parts of their programs, and these attempts at efficiency actually have a strong negative impact when debugging and maintenance are considered."&lt;br&gt;
&gt;&lt;font size = 5&gt;-- Donald Knuth
]

.pull-right5[
&lt;img src="https://therbootcamp.github.io/_slides/images/donald_knuth.jpeg" width="500"&gt;
&lt;p align="center"&gt;&lt;font size=3&gt;Donald E. Knuth&lt;br&gt;Author of &lt;a href:"https://de.wikipedia.org/wiki/The_Art_of_Computer_Programming"&gt;The Art of Programming&lt;/a&gt;&lt;br&gt;source&lt;a href="http://www-cs-faculty.stanford.edu/"&gt; http://www-cs-faculty.stanford.edu/&lt;/a&gt;
]

---

# Why is R slow? And, is it?

.pull-left4[
&gt;&lt;font size = 5&gt;R is not a fast language. This is not an accident. R was purposely designed to make data analysis and statistics easier for you to do. It was not designed to make life easier for your computer. While R is slow compared to other programming languages, for most purposes, itâ€™s fast enough.
&gt;&lt;font size = 5&gt;-- Hadley Wickham
]

.pull-right5[
### Reasons for R being slow
**Extreme dynamism** - allows you to code flexibly.
&lt;br2&gt;
**Name lookup** (in environments) - allows you to import packages and name your objects flexibly.
]

---

# Profiling

The first step to making your code efficient is figuring out the critical parts of your code. Do this using one of the following: 

| Function| Package| Description| 
|:------|:------|:------------|
| `proc.time()`  |`base`|Returns the time.|
| `system.time()`| `base`|Runs one expression once and returns elapsed CPU time|
| `microbenchmark()`|`microbenchmark`| Runs one or many expressions multiple times and returns statistics on elapsed time.|
| `lineprof(), shine()`|`lineprof`| Evaluates entire scripts. (From Hadley's Github)|

---

# Profiling: Example

Often some small part of your code takes hundreds if not thousands times longer than everything else. Profiling is about figuring out which parts of your code takes how long.

.pull-left4[

```r
  # load data
  data &lt;- read_csv('titanic.csv')
  
  # remove first column
  data &lt;- data[,-1]
  
  # mutate
  data &lt;- data %&gt;% 
    mutate(months = Age * 12)

  # multiple regression 
  model &lt;- glm(Survived ~ Sex * Age, 
              data = test_data, 
              family = 'binomial')
  
  # evaluate model
  summary(model)
```
]

---

# Improving performance

1. Look for existing solutions
2. Do less work
3. Vectorise
4. Parallelise
5. Avoid copies
6. Byte-code compile
7. Rcpp
8. Using a different R

---

# Look for an existing solution

google, stackoverflow, http://rseek.org/

other packages

within R

---

# Do as little as possible

### Or be as specifci as possible

Use tailored function, e.g., rowSums()

Sometimes this means providing more argzments

read_csv(x, with col_classes)

unlist(x, use.names = F) vs. unlist()

---

# Vectorise

many functions are vectorised, e.g., rowSums or diff()

---

# Avoid copies

whenever using c(), cbind(), rbind(), paste() R creates a copy large enough to contain its inputs.

microbenchmark(
  loop10  = collapse(strings10),
  loop100 = collapse(strings100),
  vec10   = paste(strings10, collapse = ""),
  vec100  = paste(strings100, collapse = "")
)

---

# Byte-code compiation


compiler

---

# Parallel execution

parallel example

---

# Rcpp

parallel example
---

# Alternative R implementations

pqR (pretty quick R) by Radford Neal. Built on top of R 2.15.0, it fixes many obvious performance issues, and provides better memory management and some support for automatic multithreading.

Renjin by BeDataDriven. Renjin uses the Java virtual machine, and has an extensive test suite.

FastR by a team from Purdue. FastR is similar to Renjin, but it makes more ambitious optimisations and is somewhat less mature.

Riposte by Justin Talbot and Zachary DeVito. Riposte is experimental and ambitious. For the parts of R it implements, it is extremely fast. Riposte is described in more detail in Riposte: A Trace-Driven Compiler and Parallel VM for Vector Code in R.

---

# Practical
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});
(function() {var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler"); if (!r) return; s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }"; d.head.appendChild(s);})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
